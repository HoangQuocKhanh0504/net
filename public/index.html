<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quản lý tài khoản</title>
<link rel="icon" href="GD.png" type="image/png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#1f4068,#2980b9);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;transition:background 0.3s,color 0.3s;}
body.dark{background:#1a1a1a;color:#eee;}
.hidden{display:none;}
#passGate{background:#fff;border-radius:20px;padding:40px;width:350px;text-align:center;box-shadow:0 15px 40px rgba(0,0,0,0.3);}
body.dark #passGate{background:#333;color:#eee;box-shadow:0 15px 40px rgba(0,0,0,0.7);}
#passGate h2{margin-bottom:25px;color:#1f4068;}
body.dark #passGate h2{color:#eee;}
#passGate input[type="password"]{width:100%;padding:12px;font-size:16px;border-radius:10px;border:1px solid #ccc;margin-bottom:20px;transition:all 0.3s ease;}
#passGate input:focus{border-color:#2980b9;box-shadow:0 0 8px rgba(41,128,185,0.5);outline:none;}
#passGate button{width:100%;padding:12px;font-size:16px;border:none;border-radius:10px;background:linear-gradient(90deg,#1f4068,#2980b9);color:white;cursor:pointer;transition:all 0.3s ease;}
#passGate button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.3);}
.container{width:100%;max-width:700px;background:#fff;border-radius:20px;padding:30px 40px;box-shadow:0 15px 40px rgba(0,0,0,0.2);transition:background 0.3s,color 0.3s;}
body.dark .container{background:#333;color:#eee;box-shadow:0 15px 40px rgba(0,0,0,0.7);}
.logo{width:80px;margin:0 auto 15px;display:block;}
h2{text-align:center;color:#1f4068;font-size:30px;margin-bottom:30px;}
body.dark h2{color:#eee;}
form{display:flex;flex-direction:column;gap:15px;margin-bottom:30px;}
input[type="text"], input[type="number"]{padding:14px;font-size:16px;border-radius:10px;border:1px solid #ccc;transition:all 0.3s ease;}
body.dark input[type="text"], body.dark input[type="number"]{background:#555;color:#eee;border:1px solid #888;}
input:focus{border-color:#2980b9;box-shadow:0 0 8px rgba(41,128,185,0.5);outline:none;}
button{padding:10px 16px;font-size:14px;border:none;border-radius:10px;background:linear-gradient(90deg,#1f4068,#2980b9);color:white;cursor:pointer;transition:all 0.3s ease;box-shadow:0 5px 15px rgba(0,0,0,0.2);margin-left:5px;}
button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.3);}
hr{border:none;height:1px;background:#ccc;margin:30px 0;}
ul{list-style:none;padding:0;margin:0;}
.user-card{display:flex;justify-content:space-between;align-items:center;background:#f7f7f7;padding:14px 18px;border-radius:15px;margin-bottom:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);transition:all 0.3s ease;}
body.dark .user-card{background:#444;color:#eee;box-shadow:0 6px 15px rgba(0,0,0,0.7);}
.user-card:hover{background:#e0f0ff;transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.2);}
.user-info{font-weight:500;font-size:16px;flex:1;}
.status{font-weight:600;margin-left:10px;}
.online{color:green;}
.offline{color:red;}
.btn-group{display:flex;gap:5px;}
.package-container{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;}
.package-buttons{display:flex;flex-wrap:wrap;gap:10px;}
.package-buttons button{padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(90deg,#1f4068,#2980b9);color:white;cursor:pointer;font-weight:500;box-shadow:0 5px 12px rgba(0,0,0,0.2);transition:all 0.3s;}
.package-buttons button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.3);}
.package-buttons button.selected{background:linear-gradient(90deg,#f39c12,#e74c3c);}
#customPrice{flex:1;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px;}
body.dark #customPrice{background:#555;color:#eee;border:1px solid #888;}
#searchUser{width:100%;padding:12px;margin-bottom:15px;border-radius:10px;border:1px solid #ccc;font-size:16px;}
body.dark #searchUser{background:#555;color:#eee;border:1px solid #888;}
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;z-index:999;}
#popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:15px;padding:25px 30px;box-shadow:0 15px 40px rgba(0,0,0,0.3);min-width:300px;z-index:1000;display:none;flex-direction:column;align-items:center;}
body.dark #popup{background:#444;color:#eee;box-shadow:0 15px 40px rgba(0,0,0,0.7);}
#popup p{margin-bottom:10px;font-size:16px;color:#333;text-align:center;}
body.dark #popup p{color:#eee;}
#popup input{padding:8px;width:80%;margin-top:10px;border-radius:8px;border:1px solid #ccc;}
body.dark #popup input{background:#555;color:#eee;border:1px solid #888;}
#popup button{padding:8px 14px;border:none;border-radius:10px;background:#1f4068;color:white;cursor:pointer;margin:5;}
#popup button:hover{background:#2980b9;}
#popup #popupNote{margin-top:8px;color:#555;font-size:14px;}
body.dark #popup #popupNote{color:#ccc;}
#toggleDark{position:fixed;top:10px;right:10px;padding:8px 14px;background:#1f4068;color:white;border:none;border-radius:8px;cursor:pointer;z-index:1001;}
#toggleDark:hover{background:#2980b9;}
</style>
</head>
<body>

<button id="toggleDark">Toggle Dark Mode</button>

<div id="passGate">
    <h2>Nhập mật khẩu</h2>
    <input type="password" id="passwordInput" placeholder="Mật khẩu..." autofocus autocomplete="off">
    <button onclick="checkPass()">Xác nhận</button>
    <p id="errorMsg" style="color:red;margin-top:10px;"></p>
</div>

<div id="mainContent" class="hidden">
<div class="container">
    <img src="GD.png" alt="Logo GD" class="logo">
    <h2>Quản lý tài khoản</h2>

    <form id="form">
        <input type="text" id="username" placeholder="Username" autocomplete="off" required>
        <input type="text" id="password" placeholder="Password" autocomplete="off" required>
        <div class="package-container">
            <div class="package-buttons">
                <button type="button" data-price="5000">5.000₫</button>
                <button type="button" data-price="10000">10.000₫</button>
                <button type="button" data-price="20000">20.000₫</button>
                <button type="button" data-price="50000">50.000₫</button>
                <button type="button" data-price="100000">100.000₫</button>
                <button type="button" data-price="200000">200.000₫</button>
                <button type="button" data-price="500000">500.000₫</button>
                <button type="button" data-price="1000000">1.000.000₫</button>
                <button type="button" data-price="2000000">2.000.000₫</button>
                <button type="button" data-price="5000000">5.000.000₫</button>
            </div>
            <input type="number" id="customPrice" placeholder="Hoặc nhập số tiền..." min="5000" autocomplete="off">
            <button type="submit">Tạo tài khoản</button>
        </div>
    </form>

    <hr>

    <h3>Danh sách User</h3>
    <input type="text" id="searchUser" placeholder="Tìm kiếm user..." autocomplete="off">
    <ul id="userList"></ul>
</div>
</div>

<div id="overlay"></div>
<div id="popup"></div>

<script>
const correctPass = "khanhpc5408";
const popup = document.getElementById("popup");
const overlay = document.getElementById("overlay");
const toggleDarkBtn = document.getElementById("toggleDark");

// Dark mode
if(localStorage.getItem("darkMode") === "true") document.body.classList.add("dark");
toggleDarkBtn.onclick = ()=>{
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark"));
}

// LOGIN
function checkPass(){
    const input = document.getElementById("passwordInput").value;
    const errorMsg = document.getElementById("errorMsg");
    if(input === correctPass){
        document.getElementById("passGate").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");
        loadUsers();
    } else {
        errorMsg.textContent = "Mật khẩu không đúng!";
    }
}

// ĐÓNG POPUP
function closePopup(){ popup.style.display="none"; overlay.style.display="none"; }

// CHUYỂN PHÚT SANG HH:MM:SS
function formatTimeFromMinutes(mins){
    const h = Math.floor(mins/60);
    const m = mins % 60;
    const s = 0;
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

// FORMAT TIME TỪ GIÂY
function formatTime(seconds){
    const h=Math.floor(seconds/3600);
    const m=Math.floor((seconds%3600)/60);
    const s=seconds%60;
    let str="";
    if(h>0) str+=`${h} giờ `;
    if(m>0) str+=`${m} phút `;
    str+=`${s} giây`;
    return str.trim();
}

// POPUP NẠP TIỀN
function inputPopup(msg, callback){
    popup.innerHTML = `
        <p>${msg}</p>
        <input type="number" id="popupInput" placeholder="Nhập số phút...">
        <p id="popupNote">00:00:00 = 0₫</p>
        <div style="margin-top:10px;">
            <button id="okBtn">OK</button>
            <button id="cancelBtn">Hủy</button>
        </div>
    `;
    popup.style.display="flex";
    overlay.style.display="block";

    const input = document.getElementById("popupInput");
    const note = document.getElementById("popupNote");

    input.addEventListener("input", ()=>{
        const minutes = parseInt(input.value);
        if(isNaN(minutes) || minutes <= 0){
            note.textContent = "00:00:00 = 0₫";
        } else {
            const price = Math.ceil(minutes / 60 * 5000);
            note.textContent = `${formatTimeFromMinutes(minutes)} = ${price.toLocaleString()}₫`;
        }
    });

    document.getElementById("okBtn").onclick = ()=>{
        const val = parseInt(input.value);
        closePopup();
        callback(val);
    };
    document.getElementById("cancelBtn").onclick = closePopup;
}

// POPUP ĐẶT MẬT KHẨU
function passwordPopup(msg, callback){
    popup.innerHTML = `
        <p>${msg}</p>
        <input type="password" id="popupInput" placeholder="Nhập mật khẩu mới...">
        <div style="margin-top:10px;">
            <button id="okBtn">OK</button>
            <button id="cancelBtn">Hủy</button>
        </div>
    `;
    popup.style.display="flex";
    overlay.style.display="block";

    const input = document.getElementById("popupInput");
    document.getElementById("okBtn").onclick = () => { closePopup(); callback(input.value); };
    document.getElementById("cancelBtn").onclick = closePopup;
}

// POPUP XÁC NHẬN
function confirmPopup(msg, callback){
    popup.innerHTML = `
        <p>${msg}</p>
        <div style="margin-top:10px;">
            <button id="yesBtn">Yes</button>
            <button id="noBtn">Hủy</button>
        </div>
    `;
    popup.style.display="flex";
    overlay.style.display="block";
    document.getElementById("yesBtn").onclick = ()=>{ closePopup(); callback(true); };
    document.getElementById("noBtn").onclick = ()=>{ closePopup(); callback(false); };
}

// POPUP ALERT
function alertPopup(msg){
    popup.innerHTML = `
        <p>${msg}</p>
        <div style="margin-top:10px;">
            <button id="closeBtn">OK</button>
        </div>
    `;
    popup.style.display="flex";
    overlay.style.display="block";
    document.getElementById("closeBtn").onclick = closePopup;
}

// PACKAGE BUTTONS
const packageBtns = document.querySelectorAll(".package-buttons button");
const customPrice = document.getElementById("customPrice");
packageBtns.forEach(btn=>{
    btn.addEventListener("click", ()=>{
        packageBtns.forEach(b=>b.classList.remove("selected"));
        btn.classList.add("selected");
        customPrice.value = btn.dataset.price;
    });
});
customPrice.addEventListener("input", ()=>{ packageBtns.forEach(b=>b.classList.remove("selected")); });

// FORM TẠO USER
const form = document.getElementById("form");
form.addEventListener("submit", async e=>{
    e.preventDefault();
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    let money = parseInt(customPrice.value);
    if(isNaN(money) || money<5000) money = 5000;
    const minutes = (money/5000)*60;
    const res = await fetch("/api/add_user",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,password,minutes})
    });
    const data = await res.json();
    alertPopup(data.success?"Tạo thành công":data.msg);
    loadUsers();
});

// LOAD USERS
async function loadUsers(){
    const res = await fetch("/api/list_users");
    const users = await res.json();
    const list = document.getElementById("userList");
    const existingIds = Array.from(list.children).map(li=>li.id);

    users.forEach(u=>{
        if(u.seconds <= 0) u.status = "offline";

        let li = document.getElementById(`user-${u.username}`);
        if(!li){
            li = document.createElement("li");
            li.id = `user-${u.username}`;
            li.className = "user-card";

            const info = document.createElement("span");
            info.className = "user-info";
            info.innerHTML = `${u.username} - <span class="user-time">${formatTime(u.seconds)}</span> <span class="status ${u.status}">${u.status}</span>`;
            li.appendChild(info);

            const btnGroup = document.createElement("div");
            btnGroup.className = "btn-group";

            const addBtn = document.createElement("button");
            addBtn.innerText="Nạp thêm";
            addBtn.onclick=()=>inputPopup("Nhập số phút muốn nạp thêm:", async (minutes)=>{
                if(!minutes) return;
                const res2 = await fetch("/api/add_time",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u.username,minutes})});
                const data2 = await res2.json();
                alertPopup(data2.success?"Nạp thêm thành công":data2.msg);
            });
            btnGroup.appendChild(addBtn);

            const resetBtn = document.createElement("button");
            resetBtn.innerText="Đặt lại pass";
            resetBtn.onclick=()=>passwordPopup("Nhập mật khẩu mới:", async (newPass)=>{
                if(!newPass) return;
                const res3 = await fetch("/api/reset_password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u.username,password:newPass})});
                const data3 = await res3.json();
                alertPopup(data3.success?"Đặt lại thành công":data3.msg);
            });
            btnGroup.appendChild(resetBtn);

            const delBtn = document.createElement("button");
            delBtn.innerText="Xóa";
            delBtn.onclick=()=>confirmPopup(`Xóa user ${u.username}?`, async (ok)=>{
                if(!ok) return;
                const res4 = await fetch("/api/delete_user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u.username})});
                const data4 = await res4.json();
                alertPopup(data4.success?"Xóa thành công":data4.msg);
                li.remove();
            });
            btnGroup.appendChild(delBtn);

            const payBtn = document.createElement("button");
            payBtn.innerText="Tính tiền";
            payBtn.onclick=()=>{
                const totalSeconds = u.totalSeconds || u.seconds;
                const usedSeconds = totalSeconds - u.seconds;
                const pricePerSecond = 5000 / 3600;
                let money = Math.round(usedSeconds * pricePerSecond);
                alertPopup(`User ${u.username} đã sử dụng: ${formatTime(usedSeconds)}\nTiền phải thu: ${money.toLocaleString()}₫`);
            };
            btnGroup.appendChild(payBtn);

            li.appendChild(btnGroup);
            list.appendChild(li);
        } else {
            li.querySelector(".user-time").textContent = formatTime(u.seconds);
            const statusSpan = li.querySelector(".status");
            statusSpan.textContent = u.status;
            statusSpan.className = `status ${u.status}`;
        }
    });

    existingIds.forEach(id=>{
        if(!users.find(u=>`user-${u.username}`===id)){
            const li = document.getElementById(id);
            if(li) li.remove();
        }
    });

    filterUsers();
}

// TÌM KIẾM
const searchInput=document.getElementById("searchUser");
searchInput.addEventListener("input",filterUsers);
function filterUsers(){
    const filter=searchInput.value.toLowerCase();
    document.querySelectorAll("#userList .user-card").forEach(card=>{
        const username=card.querySelector(".user-info").textContent.toLowerCase();
        card.style.display=username.includes(filter)?"flex":"none";
    });
}

// AUTO LOAD MỖI GIÂY
setInterval(async ()=>{
    if(!document.getElementById("mainContent").classList.contains("hidden")){
        await loadUsers();
    }
},1000);
</script>
</body>
</html>
